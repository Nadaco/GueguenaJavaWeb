/**
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 * @author hb
 */

/**
 * @author hb
 *
 */
package fr.iut2.gueguenajavaweb.controleur;

import fr.iut2.gueguenajavaweb.data.*;

import fr.iut2.gueguenajavaweb.data.Module;
import jakarta.servlet.RequestDispatcher;
import jakarta.servlet.ServletContext;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.util.List;

@SuppressWarnings("serial")
public class Controleur extends HttpServlet {

    private String urlAccueil;
    private String urlGestionEtudiants;
    private String urlFicheEtudiant;
    private String urlEditionNotesEtudiants;
    private String urlNotesEtudiants;
    private String urlEditionAbsencesEtudiants;
    private String urlAbsencesEtudiants;
    private String urlGestionGroupes;
    private String urlGestionModules;

    // INIT
    @Override
    public void init() throws ServletException {
        // Récupération des URLs en paramètre du web.xml
        urlGestionEtudiants = getServletConfig().getInitParameter("urlGestionEtudiants");
        urlFicheEtudiant = getServletConfig().getInitParameter("urlFicheEtudiant");
        urlEditionNotesEtudiants = getServletConfig().getInitParameter("urlEditionNotesEtudiants");
        urlAccueil = getServletConfig().getInitParameter("urlAccueil");
        urlNotesEtudiants = getServletConfig().getInitParameter("urlNotesEtudiants");
        urlAbsencesEtudiants = getServletConfig().getInitParameter("urlAbsencesEtudiants");
        urlEditionAbsencesEtudiants = getServletConfig().getInitParameter("urlEditionAbsencesEtudiants");
        urlGestionGroupes = getServletConfig().getInitParameter("urlGestionGroupes");
        urlGestionModules = getServletConfig().getInitParameter("urlGestionModules");

        // Création de la factory permettant la création d'EntityManager
        // (gestion des transactions)
        GestionFactory.open();

        ///// INITIALISATION DE LA BD
        // Normalement l'initialisation se fait directement dans la base de données
        if ((GroupeDAO.getAll().size() == 0) && (EtudiantDAO.getAll().size() == 0)) {

            // Creation des groupes
            Groupe MIAM = GroupeDAO.create("MIAM");
            Groupe SIMO = GroupeDAO.create("SIMO");
            Groupe AW = GroupeDAO.create("AW");

            // Creation des étudiants
            Etudiant etu1 = EtudiantDAO.create("Francis", "Brunet-Manquat", MIAM);
            Etudiant etu2 = EtudiantDAO.create("Philippe", "Martin", SIMO);
            Etudiant etu3 = EtudiantDAO.create("Mario", "Cortes-Cornax", AW);

            // Creation des modules
            Module JAVA = ModuleDAO.create("Java", 10);
            Module WEB = ModuleDAO.create("Web", 5);
            Module BDD = ModuleDAO.create("BDD", 15);

            // Lien entre les modules et les groupes
            MIAM.addModule(JAVA);
            MIAM.addModule(WEB);
            SIMO.addModule(JAVA);
            SIMO.addModule(BDD);
            AW.addModule(WEB);
            AW.addModule(BDD);
            AW.addModule(JAVA);

            // Creation des notes
            Note note1 = NoteDAO.create(etu1, 10, JAVA);
            Note note2 = NoteDAO.create(etu2, 12, JAVA);
            Note note3 = NoteDAO.create(etu3, 14, JAVA);
            Note note4 = NoteDAO.create(etu1, 16, WEB);
            Note note5 = NoteDAO.create(etu2, 18, WEB);
            Note note6 = NoteDAO.create(etu3, 20, WEB);
            Note note7 = NoteDAO.create(etu1, 10, BDD);
            Note note8 = NoteDAO.create(etu2, 12, BDD);
            Note note9 = NoteDAO.create(etu3, 14, BDD);


        }
    }

    @Override
    public void destroy() {
        super.destroy();

        // Fermeture de la factory
        GestionFactory.close();
    }

    // POST
    public void doPost(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
        // on passe la main au GET
        doGet(request, response);
    }

    // GET
    public void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {

        // On récupère le path
        String action = request.getPathInfo();
        if (action == null) {
            action = "/accueil";
        }

        // Exécution action
        if (action.equals("/accueil")) {
            doAccueil(request, response);
        } else if (action.equals("/gestionetudiants")) {
            doGestionEtudiants(request, response);

        } else if (action.equals("/gestiongroupes")) {
            doGestionGroupes(request, response);

        } else if (action.equals("/gestionmodules")) {
            doGestionModules(request, response);

        } else if (action.equals("/ficheetudiant")) {
            doFicheEtudiant(request, response);

        } else if (action.equals("/editionnotesetudiants")) {
            doEditionNotesEtudiant(request, response);

        } else if (action.equals("/editionabsencesetudiants")) {
            doEditionAbsencesEtudiant(request, response);

        } else if (action.equals("/modifetudiant")) {
            doModifEtudiant(request, response);

        } else if (action.equals("/notesetudiants")) {
            doNotesEtudiants(request, response);

        } else if (action.equals("/absencesetudiants")) {
            doAbsencesEtudiants(request, response);

        } else if (action.equals("/modifallnotesetudiant")) {
            doModifAllNotesEtudiant(request, response);

        } else if (action.equals("/modifallabsencesetudiant")) {
            doModifAllAbsencesEtudiant(request, response);

        } else {
            // Autres cas
            doAccueil(request, response);
        }
    }


    private void doAccueil(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
        // Récupérer les étudiants
        List<Groupe> groupes = GroupeDAO.getAll();

        // Récupérer le nombre total d'étudiant
        int nbTotalEtudiant = EtudiantDAO.getNbEtudiant();

        // Ajouter les étudiants à la requête pour affichage
        request.setAttribute("groupes", groupes);

        // Ajouter le nombre d'étudiant à ma requête pour affichage
        request.setAttribute("nbTotalEtudiant", nbTotalEtudiant);

        loadJSP(urlAccueil, request, response);
    }

    private void doGestionEtudiants(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        // Supression de l'étudiant si le formulaire de suppression a été rempli (bouton supprimer)
        if (request.getParameter("delete") != null) {

            System.out.println("delete");
            String delete = request.getParameter("delete");
            if (delete.equals("true")) {
                System.out.println("delete2");
                int idEtudiant = Integer.valueOf(request.getParameter("idEtudiant"));
                EtudiantDAO.remove(idEtudiant);
            }
        }
        // Création de l'étudiant si le formulaire de création a été rempli
        if (request.getParameter("prenom") != null) {
            // Récupère les paramètres du formulaire
            String prenom = request.getParameter("prenom");
            String nom = request.getParameter("nom");
            int idGroupe = Integer.valueOf(request.getParameter("idGroupe"));
            // Récupération du Groupe
            Groupe groupe = GroupeDAO.getById(idGroupe);

            // Création de l'étudiant
            EtudiantDAO.create(prenom, nom, groupe);

        }

        List<Etudiant> etudiants;

        if (request.getParameter("idGroupe") != null) {
            int idGroupe = Integer.valueOf(request.getParameter("idGroupe"));

            String nomGroupe = GroupeDAO.getById(idGroupe).getNom();

            // Récupérer les étudiants
            etudiants = EtudiantDAO.getAllByIdGroupe(idGroupe);

            request.setAttribute("nomGroupe", nomGroupe);
            request.setAttribute("idGroupe", idGroupe);
            request.setAttribute("isListeComplete", false);

        } else {
            // Récupérer les étudiants de tous les groupes
            etudiants = EtudiantDAO.getAll();

            request.setAttribute("nomGroupe", "");
            request.setAttribute("idGroupe", -1);
            request.setAttribute("isListeComplete", true);
        }

        // Ajouter les étudiants à la requête pour affichage
        request.setAttribute("etudiants", etudiants);

        // Ajouter les groupes non séléctionner à la requête d'affichage
        request.setAttribute("groupes", GroupeDAO.getAll());

        loadJSP(urlGestionEtudiants, request, response);
    }

    private void doGestionGroupes(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {

        // Création du groupe si le formulaire a été rempli
        if (request.getParameter("nomGroupe") != null) {
            // Récupère les paramètres du formulaire
            String nom = request.getParameter("nomGroupe");

            // Création du groupe
            GroupeDAO.create(nom);

        }

        // Récupérer les groupes
        List<Groupe> groupes = GroupeDAO.getAll();

        // Récupérer le nombre total d'étudiant
        int nbTotalEtudiant = EtudiantDAO.getNbEtudiant();

        // Ajouter les groupes à la requête pour affichage
        request.setAttribute("groupes", groupes);

        // Ajouter le nombre d'étudiant à ma requête pour affichage
        request.setAttribute("nbTotalEtudiant", nbTotalEtudiant);

        loadJSP(urlGestionGroupes, request, response);
    }

    private void doGestionModules(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {

        // Création du module si le formulaire a été rempli
        if (request.getParameter("nomModule") != null) {
            // Récupère les paramètres du formulaire
            String nom = request.getParameter("nomModule");
            int coef = Integer.valueOf(request.getParameter("coef"));

            // Création du Module
            ModuleDAO.create(nom, coef);

        }

        // Récupérer les modules
        List<Module> modules = ModuleDAO.getAll();

        // Ajouter les groupes à la requête pour affichage
        request.setAttribute("modules", modules);

        loadJSP(urlGestionModules, request, response);
    }

    private void doFicheEtudiant(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        // Récupérer l'id de l'étudiant
        int idEtudiant = Integer.valueOf(request.getParameter("id"));

        // Récupérer l'étudiant
        Etudiant etudiant = EtudiantDAO.retrieveById(idEtudiant);

        // Ajouter l'étudiant à la requête pour affichage
        request.setAttribute("etudiant", etudiant);

        loadJSP(urlFicheEtudiant, request, response);
    }

    private void doEditionNotesEtudiant(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        List<Etudiant> etudiants;

        if (request.getParameter("idGroupe") != null) {
            int idGroupe = Integer.valueOf(request.getParameter("idGroupe"));

            // Récupérer les étudiants
            etudiants = EtudiantDAO.getAllByIdGroupe(idGroupe);

            request.setAttribute("isListeComplete", false);

        } else {
            // Récupérer les étudiants de tous les groupes
            etudiants = EtudiantDAO.getAll();

            request.setAttribute("isListeComplete", true);
        }

        // Ajouter les étudiants à la requête pour affichage
        request.setAttribute("etudiants", etudiants);

        // Ajouter les groupes non séléctionner à la requête d'affichage
        request.setAttribute("groupes", GroupeDAO.getAll());

        loadJSP(urlEditionNotesEtudiants, request, response);
    }

    private void doEditionAbsencesEtudiant(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        List<Etudiant> etudiants;

        if (request.getParameter("idGroupe") != null) {
            int idGroupe = Integer.valueOf(request.getParameter("idGroupe"));

            // Récupérer les étudiants
            etudiants = EtudiantDAO.getAllByIdGroupe(idGroupe);

            request.setAttribute("isListeComplete", false);

        } else {
            // Récupérer les étudiants de tous les groupes
            etudiants = EtudiantDAO.getAll();

            request.setAttribute("isListeComplete", true);
        }

        // Ajouter les étudiants à la requête pour affichage
        request.setAttribute("etudiants", etudiants);

        // Ajouter les groupes non séléctionner à la requête d'affichage
        request.setAttribute("groupes", GroupeDAO.getAll());

        loadJSP(urlEditionAbsencesEtudiants, request, response);
    }

    private void doModifEtudiant(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {


        // Récupérer l'id de l'étudiant
        int idEtudiant = Integer.valueOf(request.getParameter("id"));

        // Récupérer l'étudiant
        Etudiant etudiant = EtudiantDAO.retrieveById(idEtudiant);

        // Modifier les notes de l'étudiant
        for (Module module : ModuleDAO.getAll()) {
            if (request.getParameter("note" + module.getId()) != null) {
                if (request.getParameter("newNote") != null) {
                    NoteDAO.create(etudiant, Float.valueOf(request.getParameter("note" + module.getId())), module);
                    break;
                }
                Note note = NoteDAO.findNoteById(Integer.valueOf(request.getParameter("idNote")));
                note.setValeur(Float.valueOf(request.getParameter("note" + module.getId())));
                NoteDAO.update(note);
                break;
            }
        }


        // Modifier les absences de l'étudiant
        if (request.getParameter("nbAbsence") != null) {
            int nbAbsence = Integer.valueOf(request.getParameter("nbAbsence"));
            if (etudiant.getNbAbsences() > 0 || (etudiant.getNbAbsences() == 0 && nbAbsence > 0)) {
                etudiant.setNbAbsences(etudiant.getNbAbsences() + nbAbsence);
            }
        }

        EtudiantDAO.update(etudiant);

        // Ajouter l'étudiant à la requête pour affichage
        request.setAttribute("etudiant", etudiant);

        loadJSP(urlFicheEtudiant + "?id=" + idEtudiant, request, response);
    }

    private void doNotesEtudiants(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        List<Etudiant> etudiants;

        if (request.getParameter("idGroupe") != null) {
            int idGroupe = Integer.valueOf(request.getParameter("idGroupe"));

            // Récupérer les étudiants
            etudiants = EtudiantDAO.getAllByIdGroupe(idGroupe);

            request.setAttribute("isListeComplete", false);

        } else {
            // Récupérer les étudiants de tous les groupes
            etudiants = EtudiantDAO.getAll();

            request.setAttribute("isListeComplete", true);
        }

        // Ajouter les étudiants à la requête pour affichage
        request.setAttribute("etudiants", etudiants);

        // Ajouter les groupes non séléctionner à la requête d'affichage
        request.setAttribute("groupes", GroupeDAO.getAll());

        loadJSP(urlNotesEtudiants, request, response);
    }

    private void doAbsencesEtudiants(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        List<Etudiant> etudiants;

        if (request.getParameter("idGroupe") != null) {
            int idGroupe = Integer.valueOf(request.getParameter("idGroupe"));

            // Récupérer les étudiants
            etudiants = EtudiantDAO.getAllByIdGroupe(idGroupe);

            request.setAttribute("isListeComplete", false);

        } else {
            // Récupérer les étudiants de tous les groupes
            etudiants = EtudiantDAO.getAll();

            request.setAttribute("isListeComplete", true);
        }

        // Ajouter les étudiants à la requête pour affichage
        request.setAttribute("etudiants", etudiants);

        // Ajouter les groupes non séléctionner à la requête d'affichage
        request.setAttribute("groupes", GroupeDAO.getAll());

        loadJSP(urlAbsencesEtudiants, request, response);
    }

    private void doModifAllNotesEtudiant(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

       /* // Récupérer l'id des étudiants
        String[] idEtudiants = request.getParameterValues("ids");

        // Récupére la moyenne des étudiants
        String[] moyennesEtudiants = request.getParameterValues("moyennes");

        //log
        for (String idEtudiant : idEtudiants) {
            System.out.println("idEtudiant : " + idEtudiant);
        }*/

        loadJSP(urlEditionNotesEtudiants, request, response);
    }

    private void doModifAllAbsencesEtudiant(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        // Récupérer l'id de l'étudiant
        int idEtudiant = Integer.valueOf(request.getParameter("id"));

        // Récupérer l'étudiant
        Etudiant etudiant = EtudiantDAO.retrieveById(idEtudiant);


        // Ajouter l'étudiant à la requête pour affichage
        request.setAttribute("etudiant", etudiant);

        loadJSP(urlFicheEtudiant + "?id=" + idEtudiant, request, response);
    }

    /**
     * Charge la JSP indiquée en paramètre
     *
     * @param url
     * @param request
     * @param response
     * @throws ServletException
     * @throws IOException
     */
    public void loadJSP(String url, HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        // L'interface RequestDispatcher permet de transférer le contrôle à une
        // autre servlet
        // Deux méthodes possibles :
        // - forward() : donne le contrôle à une autre servlet. Annule le flux
        // de sortie de la servlet courante
        // - include() : inclus dynamiquement une autre servlet
        // + le contrôle est donné à une autre servlet puis revient à la servlet
        // courante (sorte d'appel de fonction).
        // + Le flux de sortie n'est pas supprimé et les deux se cumulent

        ServletContext sc = getServletContext();
        RequestDispatcher rd = sc.getRequestDispatcher(url);
        rd.forward(request, response);
    }

}
